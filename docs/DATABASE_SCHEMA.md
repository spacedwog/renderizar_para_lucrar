# üóÑÔ∏è Database Schema - 5th Normal Form (5NF)

Este documento detalha o schema do banco de dados SQLite3 normalizado at√© a 5¬™ Forma Normal (5NF) usado na aplica√ß√£o Renderizar para Lucrar.

## üìä Vis√£o Geral

O banco de dados foi projetado seguindo os princ√≠pios de normaliza√ß√£o at√© a 5NF para:
- Eliminar redund√¢ncia de dados
- Garantir integridade referencial
- Otimizar consultas e atualiza√ß√µes
- Facilitar manuten√ß√£o e escalabilidade

## üèóÔ∏è Estrutura das Tabelas

### üë§ users
Tabela principal de usu√°rios do sistema.

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Campos:**
- `id`: Identificador √∫nico do usu√°rio
- `name`: Nome completo do usu√°rio
- `email`: Email √∫nico do usu√°rio
- `created_at`: Data/hora de cria√ß√£o da conta

### üì∏ photos
Tabela principal das fotos capturadas.

```sql
CREATE TABLE photos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uri TEXT NOT NULL,
    name TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Campos:**
- `id`: Identificador √∫nico da foto
- `uri`: Caminho/URI da imagem no sistema
- `name`: Nome do arquivo da foto
- `timestamp`: Data/hora da captura

### üìè photo_metadata
Metadados das fotos (separado para normaliza√ß√£o).

```sql
CREATE TABLE photo_metadata (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    photo_id INTEGER NOT NULL,
    width INTEGER DEFAULT 0,
    height INTEGER DEFAULT 0,
    size INTEGER DEFAULT 0,
    FOREIGN KEY (photo_id) REFERENCES photos (id) ON DELETE CASCADE
);
```

**Campos:**
- `id`: Identificador √∫nico do metadado
- `photo_id`: Refer√™ncia √† foto (FK)
- `width`: Largura da imagem em pixels
- `height`: Altura da imagem em pixels
- `size`: Tamanho do arquivo em bytes

### üé≠ ar_sessions
Sess√µes de renderiza√ß√£o AR.

```sql
CREATE TABLE ar_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

**Campos:**
- `id`: Identificador √∫nico da sess√£o
- `user_id`: Refer√™ncia ao usu√°rio (FK)
- `created_at`: Data/hora de in√≠cio da sess√£o

### üåü ar_renders
Registros de renderiza√ß√£o AR (relacionamento entre sess√µes e fotos).

```sql
CREATE TABLE ar_renders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id INTEGER NOT NULL,
    photo_id INTEGER NOT NULL,
    rendered_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    render_duration INTEGER DEFAULT 0,
    FOREIGN KEY (session_id) REFERENCES ar_sessions (id) ON DELETE CASCADE,
    FOREIGN KEY (photo_id) REFERENCES photos (id) ON DELETE CASCADE,
    UNIQUE(session_id, photo_id)
);
```

**Campos:**
- `id`: Identificador √∫nico da renderiza√ß√£o
- `session_id`: Refer√™ncia √† sess√£o AR (FK)
- `photo_id`: Refer√™ncia √† foto renderizada (FK)
- `rendered_at`: Data/hora da renderiza√ß√£o
- `render_duration`: Dura√ß√£o da renderiza√ß√£o em ms

### üè∑Ô∏è photo_tags
Tags das fotos (sistema de etiquetagem).

```sql
CREATE TABLE photo_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    photo_id INTEGER NOT NULL,
    tag_name TEXT NOT NULL,
    FOREIGN KEY (photo_id) REFERENCES photos (id) ON DELETE CASCADE,
    UNIQUE(photo_id, tag_name)
);
```

**Campos:**
- `id`: Identificador √∫nico da tag
- `photo_id`: Refer√™ncia √† foto (FK)
- `tag_name`: Nome da tag

### ‚öôÔ∏è system_config
Configura√ß√µes do sistema.

```sql
CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key TEXT UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Campos:**
- `id`: Identificador √∫nico da configura√ß√£o
- `config_key`: Chave da configura√ß√£o
- `config_value`: Valor da configura√ß√£o
- `updated_at`: Data/hora da √∫ltima atualiza√ß√£o

### üìù activity_logs
Logs de atividades do sistema.

```sql
CREATE TABLE activity_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action_type TEXT NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE SET NULL
);
```

**Campos:**
- `id`: Identificador √∫nico do log
- `user_id`: Refer√™ncia ao usu√°rio (FK, pode ser NULL)
- `action_type`: Tipo da a√ß√£o realizada
- `description`: Descri√ß√£o detalhada da a√ß√£o
- `created_at`: Data/hora da a√ß√£o

## üîç √çndices

Para otimiza√ß√£o de consultas, os seguintes √≠ndices s√£o criados:

```sql
-- √çndices para otimiza√ß√£o de consultas
CREATE INDEX idx_photos_timestamp ON photos (timestamp);
CREATE INDEX idx_ar_renders_photo_id ON ar_renders (photo_id);
CREATE INDEX idx_ar_renders_session_id ON ar_renders (session_id);
CREATE INDEX idx_photo_tags_photo_id ON photo_tags (photo_id);
CREATE INDEX idx_activity_logs_user_id ON activity_logs (user_id);
CREATE INDEX idx_activity_logs_timestamp ON activity_logs (created_at);
```

## üîó Relacionamentos

### Diagrama ER Simplificado

```
users (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) ar_sessions (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) ar_renders (N) ‚îÄ‚îÄ‚îÄ‚îÄ (1) photos
                                                                     ‚îÇ
users (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) activity_logs                                    ‚îÇ
                                                                     ‚îÇ
                                      photo_tags (N) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1)
                                                                     ‚îÇ
                                    photo_metadata (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1)
```

### Chaves Estrangeiras

1. **photo_metadata.photo_id** ‚Üí photos.id
2. **ar_sessions.user_id** ‚Üí users.id
3. **ar_renders.session_id** ‚Üí ar_sessions.id
4. **ar_renders.photo_id** ‚Üí photos.id
5. **photo_tags.photo_id** ‚Üí photos.id
6. **activity_logs.user_id** ‚Üí users.id (SET NULL)

## üìê Normaliza√ß√£o (5NF)

### 1¬™ Forma Normal (1NF)
- ‚úÖ Cada campo cont√©m valores at√¥micos
- ‚úÖ N√£o h√° grupos repetitivos
- ‚úÖ Cada registro √© √∫nico

### 2¬™ Forma Normal (2NF)
- ‚úÖ Est√° em 1NF
- ‚úÖ N√£o h√° depend√™ncias parciais
- ‚úÖ Todos os atributos n√£o-chave dependem completamente da chave prim√°ria

### 3¬™ Forma Normal (3NF)
- ‚úÖ Est√° em 2NF
- ‚úÖ N√£o h√° depend√™ncias transitivas
- ‚úÖ Metadados das fotos separados em tabela pr√≥pria

### 4¬™ Forma Normal (4NF)
- ‚úÖ Est√° em 3NF
- ‚úÖ Sistema de tags separado para evitar depend√™ncias multivaloradas
- ‚úÖ Sess√µes AR e renderiza√ß√µes separadas

### 5¬™ Forma Normal (5NF)
- ‚úÖ Est√° em 4NF
- ‚úÖ Depend√™ncias de jun√ß√£o decompostas
- ‚úÖ Relacionamento tern√°rio users-sessions-photos decomposto
- ‚úÖ Configura√ß√µes e logs separados por dom√≠nio

## üîß Consultas Comuns

### Obter fotos com metadados
```sql
SELECT 
    p.id, p.uri, p.name, p.timestamp,
    pm.width, pm.height, pm.size
FROM photos p
LEFT JOIN photo_metadata pm ON p.id = pm.photo_id
ORDER BY p.timestamp DESC;
```

### Verificar fotos renderizadas em AR
```sql
SELECT 
    p.id, p.name,
    CASE WHEN ar.photo_id IS NOT NULL THEN 1 ELSE 0 END as ar_rendered
FROM photos p
LEFT JOIN (
    SELECT DISTINCT photo_id 
    FROM ar_renders
) ar ON p.id = ar.photo_id;
```

### Obter estat√≠sticas do usu√°rio
```sql
SELECT 
    u.name,
    COUNT(DISTINCT p.id) as total_photos,
    COUNT(DISTINCT ar.photo_id) as rendered_photos,
    COUNT(DISTINCT ars.id) as ar_sessions
FROM users u
LEFT JOIN ar_sessions ars ON u.id = ars.user_id
LEFT JOIN ar_renders ar ON ars.id = ar.session_id
LEFT JOIN photos p ON ar.photo_id = p.id
WHERE u.id = ?
GROUP BY u.id;
```

### Buscar fotos por tags
```sql
SELECT DISTINCT p.*
FROM photos p
INNER JOIN photo_tags pt ON p.id = pt.photo_id
WHERE pt.tag_name LIKE '%search_term%'
ORDER BY p.timestamp DESC;
```

## üõ°Ô∏è Integridade e Constraints

### Chaves Prim√°rias
- Todas as tabelas t√™m chave prim√°ria auto-increment√°vel

### Chaves √önicas
- `users.email`: Email √∫nico por usu√°rio
- `system_config.config_key`: Chave de configura√ß√£o √∫nica
- `ar_renders(session_id, photo_id)`: Uma renderiza√ß√£o por foto por sess√£o
- `photo_tags(photo_id, tag_name)`: Tag √∫nica por foto

### Cascata e Constraints
- **CASCADE**: Deletar foto remove metadados, tags e renderiza√ß√µes
- **CASCADE**: Deletar usu√°rio remove sess√µes e renderiza√ß√µes
- **SET NULL**: Deletar usu√°rio mant√©m logs com user_id NULL

## üìà Performance

### Estrat√©gias de Otimiza√ß√£o

1. **√çndices**: Criados nos campos mais consultados
2. **Particionamento**: Por timestamp para logs antigos
3. **Desnormaliza√ß√£o controlada**: Views para consultas complexas
4. **Batch Operations**: Para inser√ß√µes em massa

### Views Recomendadas

```sql
-- View para fotos com informa√ß√µes completas
CREATE VIEW v_photos_complete AS
SELECT 
    p.id, p.uri, p.name, p.timestamp,
    pm.width, pm.height, pm.size,
    CASE WHEN ar.photo_id IS NOT NULL THEN 1 ELSE 0 END as ar_rendered,
    GROUP_CONCAT(pt.tag_name) as tags
FROM photos p
LEFT JOIN photo_metadata pm ON p.id = pm.photo_id
LEFT JOIN (SELECT DISTINCT photo_id FROM ar_renders) ar ON p.id = ar.photo_id
LEFT JOIN photo_tags pt ON p.id = pt.photo_id
GROUP BY p.id;
```

## üîÑ Migra√ß√£o e Versionamento

### Schema Versioning
```sql
-- Tabela de controle de vers√£o
CREATE TABLE schema_version (
    version TEXT PRIMARY KEY,
    applied_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO schema_version (version) VALUES ('1.0.0');
```

### Scripts de Migra√ß√£o
- `migration_001_initial.sql`: Schema inicial
- `migration_002_add_indexes.sql`: Adicionar √≠ndices
- `migration_003_add_views.sql`: Criar views

## üß™ Testes de Integridade

### Testes Automatizados
```sql
-- Verificar integridade referencial
PRAGMA foreign_key_check;

-- Verificar constraints
SELECT * FROM photos WHERE id NOT IN (SELECT photo_id FROM photo_metadata);

-- Verificar duplicatas
SELECT photo_id, tag_name, COUNT(*) 
FROM photo_tags 
GROUP BY photo_id, tag_name 
HAVING COUNT(*) > 1;
```

## üìö Refer√™ncias

- [SQLite Documentation](https://sqlite.org/docs.html)
- [Database Normalization Theory](https://en.wikipedia.org/wiki/Database_normalization)
- [React Native SQLite Storage](https://github.com/andpor/react-native-sqlite-storage)

---

**Nota**: Este schema foi otimizado para a aplica√ß√£o Renderizar para Lucrar e pode ser adaptado conforme necessidades espec√≠ficas do projeto.